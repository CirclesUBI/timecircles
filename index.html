<html>
<head>
    <title>Circles/Timecircles converter</title>
    <style>
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.42857143;
            color: #333;
            background-color: #fff;
        }
    </style>
    <script>
        /**
         * The point in time when the Circles Hub contract was deployed.
         */
        const circlesInceptionTimestamp = new Date("2020-10-15T00:00:00.000Z").getTime();
        const oneDayInMilliSeconds = 86400 * 1000;
        /**
         * Circles years have 365.25 days.
         */
        const oneCirclesYearInDays = 365.25;
        const oneCirclesYearInMilliSeconds = oneCirclesYearInDays * 24 * 60 * 60 * 1000;

        function getCrcPayoutAt(timestamp) {
            // How many days passed between the circles inception and the transaction?
            const daysSinceCirclesInception = (timestamp - circlesInceptionTimestamp) / oneDayInMilliSeconds;
            // How many circles years passed between the circles inception and the transaction?
            const circlesYearsSince = (timestamp - circlesInceptionTimestamp) / oneCirclesYearInMilliSeconds;
            // How many days passed since the last circles new-year?
            const daysInCurrentCirclesYear = daysSinceCirclesInception % oneCirclesYearInDays;
            // Everyone got 8 CRC per day in the first year
            const initialDailyCrcPayout = 8;

            let circlesPayoutInCurrentYear = initialDailyCrcPayout;
            let previousCirclesPerDayValue = initialDailyCrcPayout;

            // Add the yearly inflation to the initial payout and keep track
            // of the previous and current year's value
            for (let index = 0; index < circlesYearsSince; index++) {
                previousCirclesPerDayValue = circlesPayoutInCurrentYear;
                circlesPayoutInCurrentYear = circlesPayoutInCurrentYear * 1.07;
            }

            // The daily payout for the previous and current year
            const payoutPerDayInYear = {
                current: circlesPayoutInCurrentYear,
                previous: previousCirclesPerDayValue
            };

            // Use linear interpolation to find the 'exact' payout amount at the given point in time
            const x = payoutPerDayInYear.previous;
            const y = payoutPerDayInYear.current;
            const a = daysInCurrentCirclesYear / 365.25;

            return x * (1 - a) + y * a;
        }

        /**
         * Converts a CRC amount to a TC amount.
         * @param timestamp The point in time when the CRC transaction happened
         * @param amount The CRC value of the transaction
         * @return The TC value of the transaction
         */
        function crcToTc(timestamp, amount) {
            const ts = timestamp instanceof Date
                ? timestamp.getTime()
                : timestamp;

            const payoutAtTimestamp = getCrcPayoutAt(ts);
            return amount / payoutAtTimestamp * 24;
        }

        /**
         * Converts a TC amount to a CRC amount.
         * @param timestamp The point in time when the TC transaction happened
         * @param amount The TC value of the transaction
         * @returns The CRC value of the transaction
         */
        function tcToCrc(timestamp, amount) {
            const ts = timestamp instanceof Date
                ? timestamp.getTime()
                : timestamp;

            const payoutAtTimestamp = getCrcPayoutAt(ts);
            return amount / 24 * payoutAtTimestamp;
        }
    </script>
    <script>
        document.onreadystatechange = function () {
            // Show the user's timezone
            const timezone = document.getElementById('timezone');
            timezone.value = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const utcOffset = new Date().getTimezoneOffset() / 60;
            timezone.value += ' (UTC' + (utcOffset > 0 ? '-' : '+') + Math.abs(utcOffset) + ')';

            if (document.readyState === "complete") {
                const amount = document.getElementById('amount');
                const from = document.getElementById('from');
                const timestamp = document.getElementById('timestamp');
                const convert = document.getElementById('convert');
                const result = document.getElementById('result');

                convert.addEventListener('click', function(event) {
                    event.preventDefault();
                    const amountValue = parseFloat(amount.value);
                    const fromValue = from.value;
                    if (timestamp.value === '') {
                        timestamp.value = new Date().toLocaleString();
                    }
                    const transactionTimestamp = Date.parse(timestamp.value);

                    if (isNaN(transactionTimestamp)) {
                        result.innerText = "Invalid 'At' timestamp";
                        return;
                    }
                    if (transactionTimestamp < circlesInceptionTimestamp) {
                        result.innerText = "Transaction timestamp must be after Circles inception (2020-10-15T00:00:00.000Z)";
                        return;
                    }

                    // Show the entered timestamp in UTC in the #utc_time element
                    const utcTime = document.getElementById('utc_time');
                    utcTime.value = new Date(transactionTimestamp).toISOString();

                    if (fromValue === 'TC') {
                        result.innerText = tcToCrc(transactionTimestamp, amountValue) + " CRC";
                    } else {
                        result.innerText = crcToTc(transactionTimestamp, amountValue) + " TC"
                    }
                });
            }
        }

    </script>
    <style>
        label {
            display: inline-block;
            width:100px;
        }
        input {
            display: inline-block;
            width: 200px;
        }
    </style>
</head>
<body>
<label for="amount">Amount:</label>
<input type="text" id="amount" name="amount" value="1">
<select id="from" name="from">
    <option value="CRC">CRC -> TC</option>
    <option value="TC">TC -> CRC</option>
</select><br/>
<label for="timestamp">At (local time):</label>
<input type="text" id="timestamp" name="timestamp" value="">
<input id="convert" type="submit" value="Convert">
<br/><br/>
<label for="utc_time">At (utc time):</label>
<input style="border:none;" type="text" readonly id="utc_time" name="timestamp" value="">
<br/>
<label for="timezone">Your timezone:</label>
<input style="border:none;" type="text" readonly id="timezone" name="timestamp" value="">
<br/><br/>
<b>
<label for="result">Result:</label>
<span id="result"></span>
</b>
</body>
</html>
